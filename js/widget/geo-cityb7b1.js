jQuery(function($){JBZoo.widget('HyperPC.Geo.City',{'dadataApiKey':''},{autocompleteTimer:undefined,init:function($this){$this._subscribeGeoEvents($this);var dadataApiKey=$this.getOption('dadataApiKey');$this._defineUserLocation($this,dadataApiKey);$this.$('.jsGeoCityInput').suggestions({token:dadataApiKey,type:'ADDRESS',geoLocation:false,bounds:"city-settlement",addon:'none',minChars:3,constraints:{locations:{country:"*"}},onSelect:$this._suggestionSelect,onSuggestionsFetch:$this._suggestionFetch});},_suggestionFetch:function(suggestions){return suggestions.filter(function(suggestion){return suggestion.data.settlement_type!=='снт'&&suggestion.data.settlement_type!=='гск'&&suggestion.data.settlement_type!=='мкр'&&suggestion.data.settlement_type!=='тер'&&suggestion.data.settlement_type!=='тер. снт';});},_suggestionSelect:function(suggestion,changed){var $this=$(this).closest('[data-widgetid]').data('HyperPCGeoCity');var userLocation=$this._getUserLocation();if(userLocation.location!==suggestion.unrestricted_value){var locationData=suggestion.data;userLocation.country=locationData.country
userLocation.city=locationData.settlement||locationData.city;userLocation.location=suggestion.unrestricted_value;userLocation.fiasId=locationData.fias_id;userLocation.geoId=0;userLocation.zipCode=locationData.postal_code
if(locationData.fias_id===locationData.city_fias_id){userLocation.fiasType='city';}else if(locationData.fias_id===locationData.settlement_fias_id){userLocation.fiasType='settlement';}$('.jsCityLabel').html(userLocation.city);if(locationData.country==='Россия'){$this._getYandexAutocomplete(suggestion.unrestricted_value).done(function(response){if(response.status==='ok'){var locations=response.data.suggestions;if(locations.length===1){userLocation.geoId=locations[0].geo_id;}}else{}$this._saveUserLocation(userLocation);}).fail(function(error){$this._saveUserLocation(userLocation);});}else{$this._saveUserLocation(userLocation);}}if($(this).closest('[uk-drop]').length>0){$(this).closest('[uk-drop]').removeClass('uk-open');UIkit.drop($(this).closest('[uk-drop]')).hide();}else if($(this).closest('[uk-modal]').length>0){UIkit.modal($(this).closest('[uk-modal]')).hide();UIkit.offcanvas('#hp-offcanvas-menu').show();}$this.$('.jsGeoCityInput').val('');},_onLocationDefined:function(){this._updateCityLabel(this);},_updateCityLabel:function($this){var userLocation=$this._getUserLocation();$this.$('.jsCityLabel').html(userLocation.city);if(userLocation.location!==userLocation.city){$this.$('.jsCityLabel').attr('title',userLocation.location);}else{$this.$('.jsCityLabel').removeAttr('title');}},'click [data-geoid]':function(e,$this){var userLocation=$this._getUserLocation();if(userLocation.geoId!=$(this).data('geoid')){userLocation.country='Россия';userLocation.city=$(this).text();userLocation.location=$(this).text();userLocation.fiasId=$(this).data('fias-id');userLocation.fiasType='city';userLocation.geoId=$(this).data('geoid');userLocation.zipCode='';$this._saveUserLocation(userLocation);}if($(this).closest('[uk-drop]').length>0){$(this).closest('[uk-drop]').removeClass('uk-open');UIkit.drop($(this).closest('[uk-drop]')).hide();}else if($(this).closest('[uk-modal]').length>0){UIkit.modal($(this).closest('[uk-modal]')).hide();UIkit.offcanvas('#hp-offcanvas-menu').show();}$this.$('.jsGeoCityInput').val('');}});});